name: Build Docker Image and Push to GitHub Container Registry 

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]


jobs:
    build-and-push:
        runs-on: ubuntu-latest 
        steps:
            - name: Checkout code
              uses: actions/checkout@v4 

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                username: ${{ secrets.DOCKERHUB_USERNAME }}
                password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                context: .
                push: true
                cache-from: type=gha
                cache-to: type=gha,mode=max
                tags: |
                  ${{ secrets.DOCKERHUB_USERNAME }}/docker-2-project:latest
                  ${{ secrets.DOCKERHUB_USERNAME }}/docker-2-project:${{ github.sha }}

            - name: Run Trivy vulnerability scan 
              uses: aquasecurity/trivy-action@master
              with:
                scan-type: "image"
                image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/docker-2-project:${{github.sha}}
                format: 'sarif'
                output: 'trivy-report.sarif'

            - name: Intialize CodeQl
              uses: github/codeql-action/init@v3
              with:
                languages: go

            - name: Autobuild
              uses: github/codeql-action/autobuild@v3

            - name: Perform CodeQl Analysis
              uses: github/codeql-action/analyze@v3